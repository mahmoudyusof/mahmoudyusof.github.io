{"hash":"5b5f75d25e19532c39ff18cd701a577df7c533a1","data":{"article":{"content":"<h1 id=\"a-comprehensive-guide-for-scikit-learn-pipelines\"><a href=\"#a-comprehensive-guide-for-scikit-learn-pipelines\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>A Comprehensive Guide For scikit-learn Pipelines</h1>\n<p>Scikit Learn has a very easy and useful architecture for building complete pipelines for machine learning. In this article, we'll go through a step by step example on how to used the different features and classes of this architecture.</p>\n<hr>\n<h2 id=\"why\"><a href=\"#why\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Why?</h2>\n<p>There are plenty of reasons why you might want to use a pipeline for machine learning like:</p>\n<ul>\n<li>Combine the preprocessing step with the inference step at one object.</li>\n<li>Save the complete pipeline to disk.</li>\n<li>Easily experiment with different techniques of preprocessing.</li>\n<li>Pipeline reuse.</li>\n<li>Easy cloud deployment.</li>\n</ul>\n<hr>\n<h2 id=\"how\"><a href=\"#how\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>How?</h2>\n<p>Alright, now let's get down to business. In this article we'll use a fairly easy and old problem as an example, which is the <a class=\"mdlink\" href=\"https://www.kaggle.com/c/home-data-for-ml-course\">Regression problem for predicting housing prices</a>.<br>\nDownload the data and you should have a <code>train.csv</code> file and a <code>test.csv</code> file, we'll load both using pandas.</p>\n<hr>\n<h3 id=\"loading-the-data\"><a href=\"#loading-the-data\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Loading the data</h3>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n\ntrain_df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">\"train.csv\"</span><span class=\"token punctuation\">)</span>\ntest_df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">\"test.csv\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">## let's create a validation set from the training set</span>\n\nmsk <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>train_df<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.8</span>\n\nval_df <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span><span class=\"token operator\">~</span>msk<span class=\"token punctuation\">]</span>\n\ntrain_df <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span>msk<span class=\"token punctuation\">]</span></code></pre>\n<hr>\n<h3 id=\"feature-selection\"><a href=\"#feature-selection\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Feature selection</h3>\n<p>This data has 163 columns, however, we are not going to use all of them.<br>\nAfter doing a bit of EDA we choose a set of nominal, ordinal and numerical columns to work with.</p>\n<pre class=\"language-python\"><code class=\"language-python\">nominal <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"MSZoning\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LotShape\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LandContour\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LotConfig\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Neighborhood\"</span><span class=\"token punctuation\">,</span>\n           <span class=\"token string\">\"Condition1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BldgType\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RoofStyle\"</span><span class=\"token punctuation\">,</span>\n           <span class=\"token string\">\"Foundation\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CentralAir\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SaleType\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SaleCondition\"</span><span class=\"token punctuation\">]</span>\n\nordinal <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"LandSlope\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"OverallQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"OverallCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"YearRemodAdd\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"ExterQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ExterCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtExposure\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"KitchenQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Functional\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GarageCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PavedDrive\"</span><span class=\"token punctuation\">]</span>\n\nnumerical <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"LotFrontage\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LotArea\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MasVnrArea\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtFinSF1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtUnfSF\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"TotalBsmtSF\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1stFlrSF\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2ndFlrSF\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GrLivArea\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GarageArea\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"OpenPorchSF\"</span><span class=\"token punctuation\">]</span>\n\ntrain_features <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span>nominal <span class=\"token operator\">+</span> ordinal <span class=\"token operator\">+</span> numerical<span class=\"token punctuation\">]</span>\ntrain_label <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span><span class=\"token string\">\"SalePrice\"</span><span class=\"token punctuation\">]</span>\n\nval_features <span class=\"token operator\">=</span> val_df<span class=\"token punctuation\">[</span>nominal <span class=\"token operator\">+</span> ordinal <span class=\"token operator\">+</span> numerical<span class=\"token punctuation\">]</span>\nval_label <span class=\"token operator\">=</span> val_df<span class=\"token punctuation\">[</span><span class=\"token string\">\"SalePrice\"</span><span class=\"token punctuation\">]</span>\n\ntest_features <span class=\"token operator\">=</span> test_df<span class=\"token punctuation\">[</span>nominal <span class=\"token operator\">+</span> ordinal <span class=\"token operator\">+</span> numerical<span class=\"token punctuation\">]</span></code></pre>\n<p>If you want to see the entire selection process and EDA fully explained, you can see the notebook <a class=\"mdlink\" href=\"https://www.kaggle.com/mahmoud1youssef/housing-prices-full-solution\">here</a>  </p>\n<hr>\n<h3 id=\"preprocessing\"><a href=\"#preprocessing\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Preprocessing</h3>\n<p>Now let's choose a preprocessing plan, a very straight forward one is the following:</p>\n<ul>\n<li>\n<p>Ordinal features</p>\n<ul>\n<li>Impute missing data with most frequent value</li>\n<li>Use Ordinal Encoding</li>\n</ul>\n</li>\n<li>\n<p>Nominal Features</p>\n<ul>\n<li>Impute missing data with most frequent value</li>\n<li>Use One Hot Encoding</li>\n</ul>\n</li>\n<li>\n<p>Numerical Features</p>\n<ul>\n<li>Impute missing data with mean value</li>\n<li>Use Standard Scaling</li>\n</ul>\n</li>\n</ul>\n<p>As you may see, each family of features has its own unique way of getting processed. Let's create a Pipeline for each family.<br>\nWe can do so by using the <a class=\"mdlink\" href=\"https://scikit-learn.org/stable/modules/generated/sklearn.pipeline.Pipeline.html\">sklearn.pipeline.Pipeline</a> Object</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>pipeline <span class=\"token keyword\">import</span> Pipeline\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>impute <span class=\"token keyword\">import</span> SimpleImputer\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>preprocessing <span class=\"token keyword\">import</span> StandardScaler<span class=\"token punctuation\">,</span> OrdinalEncoder<span class=\"token punctuation\">,</span> OneHotEncoder\n\nordinal_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"imputer\"</span><span class=\"token punctuation\">,</span> SimpleImputer<span class=\"token punctuation\">(</span>strategy<span class=\"token operator\">=</span><span class=\"token string\">\"most_frequent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"encoder\"</span><span class=\"token punctuation\">,</span> OrdinalEncoder<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nnominal_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"imputer\"</span><span class=\"token punctuation\">,</span> SimpleImputer<span class=\"token punctuation\">(</span>strategy<span class=\"token operator\">=</span><span class=\"token string\">\"most_frequent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"encoder\"</span><span class=\"token punctuation\">,</span> OneHotEncoder<span class=\"token punctuation\">(</span>sparse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> handle_unknown<span class=\"token operator\">=</span><span class=\"token string\">\"ignore\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nnumerical_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"imputer\"</span><span class=\"token punctuation\">,</span> SimpleImputer<span class=\"token punctuation\">(</span>strategy<span class=\"token operator\">=</span><span class=\"token string\">\"mean\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"scaler\"</span><span class=\"token punctuation\">,</span> StandardScaler<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre>\n<p>Now let's join all of the above in one pipeline that targets each column with its family's pipeline.<br>\nWe can do so using the <a class=\"mdlink\" href=\"https://scikit-learn.org/stable/modules/generated/sklearn.compose.ColumnTransformer.html?highlight=columntransformer#sklearn.compose.ColumnTransformer\">sklearn.compose.ColumnTransformer</a> Object</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>compose <span class=\"token keyword\">import</span> ColumnTransformer\n\n<span class=\"token comment\"># here we are going to instantiate a ColumnTransformer object with a list of tuples</span>\n<span class=\"token comment\"># each of which has a the name of the preprocessor</span>\n<span class=\"token comment\"># the transformation pipeline (could be a transformer)</span>\n<span class=\"token comment\"># and the list of column names we wish to transform</span>\n\npreprocessing_pipeline <span class=\"token operator\">=</span> ColumnTransformer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"nominal_preprocessor\"</span><span class=\"token punctuation\">,</span> nominal_pipeline<span class=\"token punctuation\">,</span> nominal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"ordinal_preprocessor\"</span><span class=\"token punctuation\">,</span> ordinal_pipeline<span class=\"token punctuation\">,</span> ordinal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"numerical_preprocessor\"</span><span class=\"token punctuation\">,</span> numerical_pipeline<span class=\"token punctuation\">,</span> numerical<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">## If you want to test this pipeline run the following code</span>\n\n<span class=\"token comment\"># preprocessed_features = preprocessing_pipeline.fit_transform(train_features)</span></code></pre>\n<hr>\n<h3 id=\"adding-the-model-to-the-pipeline\"><a href=\"#adding-the-model-to-the-pipeline\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Adding the model to the pipeline</h3>\n<p>Now that we're done creating the preprocessing pipeline let's add the model to the end.</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>linear_model <span class=\"token keyword\">import</span> LinearRegression\n\ncomplete_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"preprocessor\"</span><span class=\"token punctuation\">,</span> preprocessing_pipeline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"estimator\"</span><span class=\"token punctuation\">,</span> LinearRegression<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre>\n<p>If you're waiting for the rest of the code, I'd like to tell you that that's it. Pretty easy isn't it. If the scikit-learn maintainers ask to take my heart I'd give it to them for such great API.<br>\nThe training and evaluation process is the same as any normal model</p>\n<pre class=\"language-python\"><code class=\"language-python\">complete_pipeline<span class=\"token punctuation\">.</span>fit<span class=\"token punctuation\">(</span>train_features<span class=\"token punctuation\">,</span> train_label<span class=\"token punctuation\">)</span>\nscore <span class=\"token operator\">=</span> complete_pipeline<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">(</span>val_features<span class=\"token punctuation\">,</span> val_label<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span>\n\npredictions <span class=\"token operator\">=</span> complete_pipeline<span class=\"token punctuation\">.</span>predict<span class=\"token punctuation\">(</span>test_features<span class=\"token punctuation\">)</span></code></pre>\n<hr>\n<h2 id=\"saving-and-loading-pipelines\"><a href=\"#saving-and-loading-pipelines\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Saving and Loading Pipelines</h2>\n<p>Now we want to save the entire preprocessing parameters and model parameters of this pipeline to disk and load it whenever needed.<br>\nWe are going to use <a href=\"https://joblib.readthedocs.io/en/latest/\" class=\"mdlink\">joblib</a> for this <strong>JOB</strong> ... get it? ... sorry.</p>\n<h3 id=\"save-the-pipeline\"><a href=\"#save-the-pipeline\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Save the pipeline</h3>\n<p>We are going to save the model as a pickle (.pkl) file. The code is fairly simple.</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> joblib\n\npipeline_filename <span class=\"token operator\">=</span> <span class=\"token string\">\"my_pipeline.pkl\"</span>\njoblib<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span>complete_pipeline<span class=\"token punctuation\">,</span> pipeline_filename<span class=\"token punctuation\">)</span></code></pre>\n<hr>\n<h3 id=\"load-the-pipeline\"><a href=\"#load-the-pipeline\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Load the pipeline</h3>\n<p>Now you're on your flask server and you wish to load the model to help a user predict the price of a house, so you want to load the model from disk when you start the server, or whenever a request is sent. That is also fairly simple.</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> joblib\n\npipeline_filename <span class=\"token operator\">=</span> <span class=\"token string\">\"path/to/pipeline/file.pkl\"</span>\n\npipeline <span class=\"token operator\">=</span> joblib<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>pipeline_filename<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">## do inference with pipeline.predict</span>\n<span class=\"token comment\"># ...</span></code></pre>\n<hr>\n<h2 id=\"full-code\"><a href=\"#full-code\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Full Code</h2>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n\ntrain_df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">\"train.csv\"</span><span class=\"token punctuation\">)</span>\ntest_df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">\"test.csv\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">## let's create a validation set from the training set</span>\n\nmsk <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>train_df<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.8</span>\n\nval_df <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span><span class=\"token operator\">~</span>msk<span class=\"token punctuation\">]</span>\n\ntrain_df <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span>msk<span class=\"token punctuation\">]</span>\n\n\nnominal <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"MSZoning\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LotShape\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LandContour\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LotConfig\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Neighborhood\"</span><span class=\"token punctuation\">,</span>\n           <span class=\"token string\">\"Condition1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BldgType\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RoofStyle\"</span><span class=\"token punctuation\">,</span>\n           <span class=\"token string\">\"Foundation\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CentralAir\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SaleType\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SaleCondition\"</span><span class=\"token punctuation\">]</span>\n\nordinal <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"LandSlope\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"OverallQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"OverallCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"YearRemodAdd\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"ExterQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ExterCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtExposure\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">\"KitchenQual\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Functional\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GarageCond\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"PavedDrive\"</span><span class=\"token punctuation\">]</span>\n\nnumerical <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"LotFrontage\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"LotArea\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MasVnrArea\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtFinSF1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"BsmtUnfSF\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"TotalBsmtSF\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1stFlrSF\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2ndFlrSF\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GrLivArea\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"GarageArea\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"OpenPorchSF\"</span><span class=\"token punctuation\">]</span>\n\ntrain_features <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span>nominal <span class=\"token operator\">+</span> ordinal <span class=\"token operator\">+</span> numerical<span class=\"token punctuation\">]</span>\ntrain_label <span class=\"token operator\">=</span> train_df<span class=\"token punctuation\">[</span><span class=\"token string\">\"SalePrice\"</span><span class=\"token punctuation\">]</span>\n\nval_features <span class=\"token operator\">=</span> val_df<span class=\"token punctuation\">[</span>nominal <span class=\"token operator\">+</span> ordinal <span class=\"token operator\">+</span> numerical<span class=\"token punctuation\">]</span>\nval_label <span class=\"token operator\">=</span> val_df<span class=\"token punctuation\">[</span><span class=\"token string\">\"SalePrice\"</span><span class=\"token punctuation\">]</span>\n\ntest_features <span class=\"token operator\">=</span> test_df<span class=\"token punctuation\">[</span>nominal <span class=\"token operator\">+</span> ordinal <span class=\"token operator\">+</span> numerical<span class=\"token punctuation\">]</span>\n\n\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>pipeline <span class=\"token keyword\">import</span> Pipeline\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>impute <span class=\"token keyword\">import</span> SimpleImputer\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>preprocessing <span class=\"token keyword\">import</span> StandardScaler<span class=\"token punctuation\">,</span> OrdinalEncoder<span class=\"token punctuation\">,</span> OneHotEncoder\n\nordinal_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"imputer\"</span><span class=\"token punctuation\">,</span> SimpleImputer<span class=\"token punctuation\">(</span>strategy<span class=\"token operator\">=</span><span class=\"token string\">\"most_frequent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"encoder\"</span><span class=\"token punctuation\">,</span> OrdinalEncoder<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nnominal_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"imputer\"</span><span class=\"token punctuation\">,</span> SimpleImputer<span class=\"token punctuation\">(</span>strategy<span class=\"token operator\">=</span><span class=\"token string\">\"most_frequent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"encoder\"</span><span class=\"token punctuation\">,</span> OneHotEncoder<span class=\"token punctuation\">(</span>sparse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> handle_unknown<span class=\"token operator\">=</span><span class=\"token string\">\"ignore\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nnumerical_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"imputer\"</span><span class=\"token punctuation\">,</span> SimpleImputer<span class=\"token punctuation\">(</span>strategy<span class=\"token operator\">=</span><span class=\"token string\">\"mean\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"scaler\"</span><span class=\"token punctuation\">,</span> StandardScaler<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>compose <span class=\"token keyword\">import</span> ColumnTransformer\n\n<span class=\"token comment\"># here we are going to instantiate a ColumnTransformer object with a list of tuples</span>\n<span class=\"token comment\"># each of which has a the name of the preprocessor</span>\n<span class=\"token comment\"># the transformation pipeline (could be a transformer)</span>\n<span class=\"token comment\"># and the list of column names we wish to transform</span>\n\npreprocessing_pipeline <span class=\"token operator\">=</span> ColumnTransformer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"nominal_preprocessor\"</span><span class=\"token punctuation\">,</span> nominal_pipeline<span class=\"token punctuation\">,</span> nominal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"ordinal_preprocessor\"</span><span class=\"token punctuation\">,</span> ordinal_pipeline<span class=\"token punctuation\">,</span> ordinal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"numerical_preprocessor\"</span><span class=\"token punctuation\">,</span> numerical_pipeline<span class=\"token punctuation\">,</span> numerical<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">## If you want to test this pipeline run the following code</span>\n\n<span class=\"token comment\"># preprocessed_features = preprocessing_pipeline.fit_transform(train_features)</span>\n\n\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>linear_model <span class=\"token keyword\">import</span> LinearRegression\n\ncomplete_pipeline <span class=\"token operator\">=</span> Pipeline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"preprocessor\"</span><span class=\"token punctuation\">,</span> preprocessing_pipeline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token string\">\"estimator\"</span><span class=\"token punctuation\">,</span> LinearRegression<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n\ncomplete_pipeline<span class=\"token punctuation\">.</span>fit<span class=\"token punctuation\">(</span>train_features<span class=\"token punctuation\">,</span> train_label<span class=\"token punctuation\">)</span>\nscore <span class=\"token operator\">=</span> complete_pipeline<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">(</span>val_features<span class=\"token punctuation\">,</span> val_label<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span>\n\npredictions <span class=\"token operator\">=</span> complete_pipeline<span class=\"token punctuation\">.</span>predict<span class=\"token punctuation\">(</span>test_features<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">import</span> joblib\n\npipeline_filename <span class=\"token operator\">=</span> <span class=\"token string\">\"my_pipeline.pkl\"</span>\njoblib<span class=\"token punctuation\">.</span>dump<span class=\"token punctuation\">(</span>complete_pipeline<span class=\"token punctuation\">,</span> pipeline_filename<span class=\"token punctuation\">)</span>\n\n\npipeline <span class=\"token operator\">=</span> joblib<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>pipeline_filename<span class=\"token punctuation\">)</span>\n\npredictions <span class=\"token operator\">=</span> pipeline<span class=\"token punctuation\">.</span>predict<span class=\"token punctuation\">(</span>test_df<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>predictions<span class=\"token punctuation\">)</span></code></pre>\n<hr>\n<p>That's it, Congratulations, you've just created, saved and loaded your complete pipeline.<br>\nI hope this article was helpful, if not, please tell me how to improve it, I would really appreciate that.\nThank you.</p>\n<hr>\n<p><a class=\"mdlink\" href=\"https://www.oreilly.com/library/view/hands-on-machine-learning/9781492032632/\">Reference Book</a></p>\n<p><a class=\"mdlink\" href=\"https://www.kaggle.com/mahmoud1youssef/housing-prices-full-solution\">My Notebook</a></p>\n","id":"572186991bdbc74f1608d4c493bf4962","title":"A Comprehensive Guide For scikit-learn Pipelines","type":"article","description":"Going through a step by step guide for building machine learning pipelines for data preprocessing and inference, also covering how preprocess different columns with different transformers, how to add custom transformers, and how to save and load complete pipelines","image":"https://mahmoudyusof.github.io/seo_images/sklearn-pipelines.jpg","url":"https://mahmoudyusof.github.io/general/scikit-learn-pipelines/"}},"context":{}}